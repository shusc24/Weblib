/**

 @Name：layui.flow 流加载
 @Author：贤心
 @License：LGPL


 @重写使用全局模式
 */
define(['jquery'],function($){Flow=function(options){},ELEM_MORE='layui-flow-more',ELEM_LOAD='<i class="fa fa-spinner fa-spin fa-2x fa-fw"></i>';Flow.prototype.load=function(options){var that=this,page=0,lock,isOver,lazyimg,timer;options=options||{};var elem=$(options.elem);if(!elem[0]){return}var scrollElem=$(options.scrollElem||document);var mb=options.mb||50;var isAuto='isAuto'in options?options.isAuto:true;var end=options.end||'没有更多了';var notDocment=options.scrollElem&&options.scrollElem!==document;var ELEM_TEXT='<cite>加载更多</cite>',more=$('<div class="layui-flow-more"><a href="javascript:;">'+ELEM_TEXT+'</a></div>');if(!elem.find('.layui-flow-more')[0]){elem.append(more)}var next=function(html,over){html=$(html);more.before(html);over=over==0?true:null;over?more.html(end):more.find('a').html(ELEM_TEXT);isOver=over;lock=null;lazyimg&&lazyimg()};var done=function(){lock=true;more.find('a').html(ELEM_LOAD);typeof options.done==='function'&&options.done(page+=1,next)};done();more.find('a').on('click',function(){var othis=$(this);if(isOver){return}lock||done()});if(options.isLazyimg){var lazyimg=that.lazyimg({elem:options.elem+' img',scrollElem:options.scrollElem})}if(!isAuto){return that}scrollElem.on('scroll',function(){var othis=$(this),top=othis.scrollTop();if(timer){clearTimeout(timer)}if(isOver){return}timer=setTimeout(function(){var height=notDocment?othis.height():$(window).height();var scrollHeight=notDocment?othis.prop('scrollHeight'):document.documentElement.scrollHeight;if(scrollHeight-top-height<=mb){lock||done()}},100)});return that};Flow.prototype.lazyimg=function(options){var that=this,index=0,haveScroll;options=options||{};var scrollElem=$(options.scrollElem||document);var elem=options.elem||'img';var notDocment=options.scrollElem&&options.scrollElem!==document;var show=function(item,height){var start=scrollElem.scrollTop(),end=start+height;var elemTop=notDocment?function(){return item.offset().top-scrollElem.offset().top+start}():item.offset().top;if(elemTop>=start&&elemTop<=end){if(!item.attr('src')){var src=item.attr('lay-src');layui.img(src,function(){var next=that.lazyimg.elem.eq(index);item.attr('src',src).removeAttr('lay-src');next[0]&&render(next);index+=1})}}},render=function(othis,scroll){var height=notDocment?(scroll||scrollElem).height():$(window).height();var start=scrollElem.scrollTop(),end=start+height;that.lazyimg.elem=$(elem);if(othis){show(othis,height)}else{for(var i=0;i<that.lazyimg.elem.length;i+=1){var item=that.lazyimg.elem.eq(i),elemTop=notDocment?function(){return item.offset().top-scrollElem.offset().top+start}():item.offset().top;show(item,height);index=i;if(elemTop>end){break}}}};render();if(!haveScroll){var timer;scrollElem.on('scroll',function(){var othis=$(this);if(timer){clearTimeout(timer)}timer=setTimeout(function(){render(null,othis)},50)});haveScroll=true}return render};return new Flow()});