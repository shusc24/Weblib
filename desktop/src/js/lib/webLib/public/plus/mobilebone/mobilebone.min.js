/*
 * mobilebone.js
 * by zhangxinxu(.com) 2014-09-26
 * https://github.com/zhangxinxu/mobilebone
 * bone of switch for mobile web app
**/
(function(root,factory){if(document.MBLOADED){return}if(typeof define==='function'&&(define.amd||define.cmd)){define('mobilebone',function(exports){return factory(root,exports)});}else{root.Mobilebone=factory(root,{})}})(this,function(root,Mobilebone){if(document.MBLOADED){return 'Don\'t repeat load Mobilebone!'}var store={};var array=[];var slice=array.slice;var isSimple=/^#?\w+(?:[\-_]\w+)*$/i;var isWebkit='WebkitAppearance'in document.documentElement.style||typeof document.webkitHidden!="undefined";var supportHistory="pushState"in history&&"replaceState"in history;Mobilebone.support=supportHistory;var hasInited=false;Mobilebone.VERSION='2.6.2';Mobilebone.captureLink=true;Mobilebone.captureForm=true;Mobilebone.rootTransition=root;Mobilebone.mergeCallback=true;Mobilebone.classAnimation="slide";Mobilebone.classPage="page";Mobilebone.classMask="mask";Mobilebone.pushStateEnabled=true;Mobilebone.evalScript=false;if((window.navigator.userAgent.indexOf("Firefox")>=0&&window.top!==window)){Mobilebone.pushStateEnabled=false}if(supportHistory==false){return Mobilebone}history.popstate=false;Mobilebone.transition=function(pageInto,pageOut,back,options){if(arguments.length==0||pageInto==pageOut){return}if(arguments.length==3&&isNaN(back*1)==true){options=back;back=options.back};pageOut=pageOut||null,back=back||false,options=options||{};var defaults={root:this.rootTransition,form:this.form||this.classAnimation,onpagefirstinto:this.onpagefirstinto,animationstart:this.animationstart,animationend:this.animationend,preventdefault:this.preventdefault,fallback:this.fallback,callback:this.callback},params=function(element){if(!element||!element.getAttribute){return{}}var _params={},_dataparams=_queryToObject(element.getAttribute("data-params")||'');["title","root","form"].forEach(function(key){_params[key]=element.getAttribute("data-"+key)||_dataparams[key]||options[key]||defaults[key]});if(typeof _params.root=="string"){_params.root=Mobilebone.getFunction(_params.root)}["onpagefirstinto","callback","fallback","animationstart","animationend","preventdefault"].forEach(function(key){if(Mobilebone.mergeCallback==true&&typeof defaults[key]=="function"){var local_function_key=element.getAttribute("data-"+key)||_dataparams[key];if(typeof _params.root[local_function_key]=="function"){_params[key]=function(){defaults[key].apply(this,arguments);_params.root[local_function_key].apply(this,arguments)}}else if(typeof options[key]=="function"){_params[key]=function(){defaults[key].apply(this,arguments);options[key].apply(this,arguments)}}else{_params[key]=defaults[key]}}else{_params[key]=element.getAttribute("data-"+key)||_dataparams[key]||options[key]||defaults[key]}});return _params};var params_out=params(pageOut),params_in=params(pageInto);if(pageOut!=null&&pageOut.classList){var preventOut=params_out.preventdefault,isPreventOut=false;if(typeof preventOut=="string"){preventOut=params_out.root[preventOut]}}if(pageInto!=null&&pageInto.classList){var preventInto=params_in.preventdefault,isPreventInto=false;if(typeof preventInto=="string"){preventInto=params_in.root[preventInto]}}if(typeof preventOut=="function"){isPreventOut=preventOut.call(params_out.root,pageInto,pageOut,options)}if(isPreventOut==true&&preventOut===preventInto){return false}if(typeof preventInto=="function"){isPreventInto=preventInto.call(params_in.root,pageInto,pageOut,options)}if(isPreventInto==true){return false}var fun_animationCall=function(page,data){if(page.flagAniBind==true){return}["animationstart","animationend"].forEach(function(animationkey,index){var animition=params_in[animationkey],webkitkey="webkit"+animationkey.replace(/^a|s|e/g,function(matchs){return matchs.toUpperCase()});var animateEventName=isWebkit?webkitkey:animationkey;if(index){page.addEventListener(animateEventName,function(){if(this.classList.contains("in")==false){this.style.display="none";if(this.removeSelf==true){this.parentElement.removeChild(this);this.removeSelf=null}}this.classList.remove(params(this).form)})}if(typeof animition=="string"&&params_in.root[animition]){page.addEventListener(animateEventName,function(){data.root[animition].call(data.root,this,this.classList.contains("in")?"into":"out",options)})}else if(typeof animition=="function"){page.addEventListener(animateEventName,function(){animition.call(data.root,this,this.classList.contains("in")?"into":"out",options)})}page.flagAniBind=true})};if(pageOut!=null&&pageOut.classList){if(isPreventOut!=true){pageOut.classList.add(params_out.form);pageOut.offsetWidth=pageOut.offsetWidth;pageOut.style.display="block";pageOut.classList.add("out");pageOut.classList.remove("in");pageOut.classList[back?"add":"remove"]("reverse");pageOut.removeSelf=pageOut.removeSelf||null;fun_animationCall(pageOut,params_out);var fallback=params_out.fallback;if(typeof fallback=="string"){fallback=params_out.root[fallback]}if(typeof fallback=="function"){fallback.call(params_out.root,pageInto,pageOut,options)}}}if(pageInto!=null&&pageInto.classList){var title=params_in.title,header=document.querySelector("h1"),first_page=document.querySelector("."+this.classPage);if(title&&options.title!==false){document.title=title;if(header){header.innerHTML=title;header.title=title}}else if(first_page==pageInto&&!pageOut&&document.title){pageInto.setAttribute("data-title",document.title)}var pageid=options.id||pageInto.id,hashid=options.id||pageInto.id;if(options.id){pageid=pageid.split("?")[0]}var relid=store["_"+pageid];if(options.remove!==false&&store[pageid]&&store[pageid]!=pageInto){if(relid&&store[relid]&&options.reload==true){delete store[relid];delete store["_"+pageid]}if(store[pageid]!=pageOut){store[pageid].parentElement&&store[pageid].parentElement.removeChild(store[pageid])}else{pageOut.removeSelf=true}delete store[pageid]}if(pageOut){pageInto.classList.add(params_in.form)}pageInto.offsetWidth=pageInto.offsetWidth;pageInto.style.display="block";pageInto.classList.remove("out");pageInto.classList.add("in");pageInto.classList[back?"add":"remove"]("reverse");var onpagefirstinto=params_in.onpagefirstinto;if(!pageInto.firstintoBind){if(typeof onpagefirstinto=="string"&&params_in.root[onpagefirstinto]){params_in.root[onpagefirstinto].call(params_in.root,pageInto,pageOut,options)}else if(typeof onpagefirstinto=="function"){onpagefirstinto.call(params_in.root,pageInto,pageOut,options)}slice.call(pageInto.querySelectorAll("form")).forEach(function(form){Mobilebone.submit(form)});pageInto.firstintoBind=true}fun_animationCall(pageInto,params_in);var url_push=hashid,url_push_replaced='';if(url_push&&/^#/.test(url_push)==false){url_push="#"+url_push}url_push_replaced=url_push.replace(/^#/,"#&");if(supportHistory&&this.pushStateEnabled&&options.history!==false&&url_push &&url_push_replaced!=location.hash){history.popstate=false;history[pageOut?"pushState":"replaceState"](null,document.title,url_push.replace(/^#/,"#&"))}if(!store[pageid]){store[pageid]=pageInto;if(hashid!==pageid){store[hashid]=pageInto;store["_"+pageid]=hashid}}var callback=params_in.callback;if(typeof callback=="string"){callback=params_in.root[callback]}if(typeof callback=="function"){callback.call(params_in.root,pageInto,pageOut,options)}setTimeout(function(){history.popstate=true},17)}};Mobilebone.getCleanUrl=function(trigger,url,params){var href="",formdata="",clean_url="";if(trigger){if(trigger.nodeType==1){if(trigger.action){href=trigger.getAttribute("action");if(trigger.method&&trigger.method.toUpperCase()=="POST"){return href}else if(window.$&&$.fn&&$.fn.serialize){formdata=$(trigger).serialize()}else{formdata={};slice.call(trigger.querySelectorAll("input,select,textarea")).forEach(function(control){if(control.name&&!control.disabled){var val=control.value.trim(),name=control.name;if(/^radio|checkbox/i.test(control.type)){if(control.checked){if(formdata[name]){formdata[name].push(val)}else{formdata[name]=[val]}}}else{formdata[name]=[val]}}})}}else{href=trigger.getAttribute("href");formdata=trigger.getAttribute("data-formdata")||trigger.getAttribute("data-data")||"";var str_container="container",attr_container=trigger.getAttribute("data-"+str_container);if(formdata.indexOf(str_container)==-1&&attr_container){var query_container=str_container+"="+attr_container;formdata=formdata?formdata+"&"+query_container:query_container}}}else if(trigger.url){href=trigger.url;formdata=trigger.data}}if(!(href=href||url)){return ''}formdata=formdata||params||"";if(typeof formdata=="object"){var arr_data=[];for(key in formdata){if(!formdata[key].forEach){formdata[key]=[formdata[key]]}formdata[key].forEach(function(keyValue){arr_data.push(key+"="+encodeURIComponent(keyValue))})}if(arr_data.length>0){formdata=arr_data.join("&")}else{formdata=""}}clean_url=href.split("#")[0].replace(/&+$/,"");if(clean_url.slice(-1)=="?"){clean_url=clean_url.split("?")[0]}if(formdata!=""){if(/\?/.test(clean_url)){formdata=formdata.replace(/^&|\?/,"");clean_url=clean_url+"&"+formdata}else if(formdata!=""){formdata=formdata.replace("?","");clean_url=clean_url+"?"+formdata}}return clean_url};Mobilebone.createPage=function(domHtml,eleOrObj,options){var response=null,container=null,classPage=this.classPage,isreload=null;if(!domHtml){return}if(typeof options=="undefined"&&typeof eleOrObj=="object"){options=eleOrObj}options=options||{};var optionsTransition={};var page_title,id_container,classPageInside;if(eleOrObj){if(eleOrObj.nodeType==1){if(eleOrObj.href||eleOrObj.action){page_title=eleOrObj.getAttribute("data-title")||options.title}response=options.response;id_container=eleOrObj.getAttribute("data-container");container=document.getElementById(id_container);classPageInside=eleOrObj.getAttribute("data-classpage");optionsTransition.target=eleOrObj;isreload=eleOrObj.getAttribute("data-reload");if(eleOrObj.tagName.toLowerCase()=="form"||(isreload!==null&&isreload!="false")){optionsTransition.reload=true}optionsTransition.back=eleOrObj.getAttribute("data-rel")=="back";if(eleOrObj.getAttribute("data-history")=="false"){optionsTransition.history=false}}else{response=eleOrObj.response||options.response;page_title=eleOrObj.title||options.title;container=eleOrObj.container||options.container;classPageInside=eleOrObj.classPage||options.classPage;optionsTransition.target=eleOrObj.target;optionsTransition.back=eleOrObj.back||options.back}if(container&&classPageInside){classPage=classPageInside}}var current_page=(classPage==classPageInside?container:document).querySelector(".in."+classPage);var create_page=null;var create=document.createElement("div");if(typeof domHtml=="string"){create.innerHTML=domHtml}else{create.appendChild(domHtml)}if(Mobilebone.evalScript==true&&domHtml.firstintoBind!=true){slice.call(create.getElementsByTagName("script")).forEach(function(originScript){var scriptContent=originScript.innerHTML.trim(),type=originScript.getAttribute("type");if(scriptContent.trim()==""||originScript.src){return}var head=document.getElementsByTagName("head")[0]||document.documentElement,script=document.createElement("script");if(type){script.type=type}script.appendChild(document.createTextNode(scriptContent));setTimeout(function(){head.insertBefore(script,head.firstChild);head.removeChild(script);script=null},17);originScript=null})}var create_title=create.getElementsByTagName("title")[0];if(!(create_page=create.querySelector("."+classPage))){create.className=classPage+" out";create_page=create}if(typeof page_title=="string"){create_page.setAttribute("data-title",page_title)}else if(create_title&&create_title.innerText){create_page.setAttribute("data-title",create_title.innerText)}optionsTransition.response=response||domHtml;optionsTransition.id=this.getCleanUrl(eleOrObj)||create_page.id||("unique"+Date.now());if(typeof options=="object"){if(typeof options.history!="undefined"){optionsTransition.history=options.history}if(typeof options.remove!="undefined"){optionsTransition.remove=options.remove}if(typeof options.target!="undefined"){optionsTransition.target=options.target}if(typeof options.title!="undefined"){optionsTransition.title=options.title}}if(classPage==classPageInside){optionsTransition.history=false;optionsTransition.classPage=classPage}container=container||document.body;var pageid=optionsTransition.id.split("?")[0];if(pageid&&store[pageid]&&container.contains(store[pageid])){container.insertBefore(create_page,store[pageid])}else{container.appendChild(create_page)}create=null;this.transition(create_page,current_page,optionsTransition)};Mobilebone.getFunction=function(keys){if(typeof keys!="string"){return}var fun=root,arr_key=keys.split(".");for(var index=0;index<arr_key.length;index+=1){if(!(fun=fun[arr_key[index]])){break}}return fun};Mobilebone.ajax=function(aOrFormOrObj){if(!aOrFormOrObj){return}var defaults={url:"",type:"",dataType:"",data:{},timeout:10000,async:true,username:"",password:"",success:function(){},error:function(){},complete:function(){}};var params={},ele_mask=null,formData=null;var params_from_trigger={},attr_mask;if(aOrFormOrObj.nodeType==1){params_from_trigger=_queryToObject(aOrFormOrObj.getAttribute("data-params")||"");for(key in defaults){params[key]=aOrFormOrObj.getAttribute("data-"+key)||params_from_trigger[key]||defaults[key];if(typeof defaults[key]=="function"&&typeof params[key]=="string"){params[key]=this.getFunction(params[key]);if(typeof params[key]!="function"){params[key]=defaults[key]}}}params.url=this.getCleanUrl(aOrFormOrObj,params.url);params.target=aOrFormOrObj;params.back=aOrFormOrObj.getAttribute("data-rel")=="back";var tagName=aOrFormOrObj.tagName.toLowerCase();if(tagName=="form"){params.type=aOrFormOrObj.method;formData=new FormData(aOrFormOrObj)}else if(tagName=="a"){var idContainer=aOrFormOrObj.getAttribute("data-container"),classPageInside=aOrFormOrObj.getAttribute("data-classpage"),container=idContainer&&document.getElementById(idContainer);if(container&&classPageInside&&classPageInside!=Mobilebone.classPage){params.history=false;params.title=false}}attr_mask=aOrFormOrObj.getAttribute("data-mask");if(attr_mask=="true"||attr_mask==""){ele_mask=aOrFormOrObj.querySelector("."+this.classMask)}}else if(aOrFormOrObj.url){for(key2 in defaults){params[key2]=aOrFormOrObj[key2]||defaults[key2]}params.url=this.getCleanUrl(null,params.url,params.data);params.title=aOrFormOrObj.title;params.back=aOrFormOrObj.back;params.container=aOrFormOrObj.container}else{return}var body=container||document.body;if(typeof attr_mask!="string"){ele_mask=body.querySelector("."+this.classMask)}if(ele_mask==null){ele_mask=document.createElement("div");ele_mask.className=this.classMask;ele_mask.innerHTML='<i class="loading"></i>';if(typeof attr_mask=="string"){aOrFormOrObj.appendChild(ele_mask)}else{body.appendChild(ele_mask)}}ele_mask.style.display="block";var xhr=new XMLHttpRequest();xhr.open(params.type||"GET",params.url+(/\?/.test(params.url)?"&":"?")+"r="+Date.now(),params.async,params.username,params.password);xhr.timeout=params.timeout;xhr.onload=function(){var response=null;if(xhr.status==200){if(params.dataType=="json"||params.dataType=="JSON"){try{response=JSON.parse(xhr.response);params.response=response;Mobilebone.createPage(Mobilebone.jsonHandle(response),aOrFormOrObj,params)}catch(e){params.message="JSON parse error："+e.message;params.error.call(params,xhr,xhr.status)}}else if(params.dataType=="unknown"){params.history=false;try{response=JSON.parse(xhr.response);params.response=response;Mobilebone.createPage(Mobilebone.jsonHandle(response),aOrFormOrObj,params)}catch(e){response=xhr.response;Mobilebone.createPage(response,aOrFormOrObj,params)}}else{response=xhr.response;Mobilebone.createPage(response,aOrFormOrObj,params)}params.success.call(params,response,xhr.status)}else{params.message="The status code exception!";params.error.call(params,xhr,xhr.status)}params.complete.call(params,xhr,xhr.status);ele_mask.style.display="none"};xhr.onerror=function(e){params.message="Illegal request address or an unexpected network error!";params.error.call(params,xhr,xhr.status);ele_mask.style.display="none"};xhr.ontimeout=function(){params.message="The request timeout!";params.error.call(params,xhr,xhr.status);ele_mask.style.display="none"};xhr.setRequestHeader("Type","ajax");xhr.setRequestHeader("From","mobilebone");xhr.send(formData)};Mobilebone.submit=function(form){if(!form||typeof form.action!="string"){return}var ajax=form.getAttribute("data-ajax");if(ajax=="false"||(Mobilebone.captureForm==false&&ajax!="true")){return}form.addEventListener("submit",function(event){var attrPrevent=this.getAttribute("data-preventdefault");var funPrevent=Mobilebone.getFunction(attrPrevent);if(typeof funPrevent=="function"&&funPrevent(this)==true){event.preventDefault();return false}Mobilebone.ajax(this);event.preventDefault()})};Mobilebone.isBack=function(page_in,page_out){if(history.tempBack==true){history.tempBack=null;return true}if(typeof page_in=="undefined"){return true}if(!page_out){return false}return page_in.compareDocumentPosition(page_out)==4};Mobilebone.jsonHandle=function(json){return '<p style="text-align:center;">Dear master, if you see me, show that JSON parsing function is undefined!</p>'},Mobilebone.init=function(){if(hasInited==true){return 'Don\'t repeat initialization!'}var hash=location.hash.replace("#&","#"),ele_in=null,container=null;if(hash==""||hash=="#"){this.transition(document.querySelector("."+this.classPage))}else if(isSimple.test(hash)==true&&(ele_in=document.querySelector(hash))&&ele_in.classList.contains(this.classPage)){this.transition(ele_in)}else{if(hash.split("container=").length==2){container=document.getElementById(hash.split("container=")[1].split("&")[0])}this.ajax({url:hash.replace("#",""),dataType:"unknown",container:container,error:function(){ele_in=document.querySelector("."+Mobilebone.classPage);Mobilebone.transition(ele_in)}})}var $=root.$||root.jQuery||root.Zepto;if($&&$.fn&&$.fn.tap&&('ontouchstart'in window==true)){$(document).tap(this.handleTapEvent);document.addEventListener("click",function(event){var target=event.target;if(!target){return}if(target.tagName.toLowerCase()!="a"&&!(target=target.getParentElementByTag("a"))){return}var ajax=target.getAttribute("data-ajax"),href=target.href;if(target.getAttribute("data-rel")=="external"||ajax=="false"||(href.replace("://","").split("/")[0]!==location.href.replace("://","").split("/")[0]&&ajax!="true")||(Mobilebone.captureLink==false&&ajax!="true")){if(/^http/i.test(href)){location.href=href}return}event.preventDefault()})}else{document.addEventListener("click",this.handleTapEvent)}var isSafari7=!!navigator.userAgent.match(/safari/i)&&!navigator.userAgent.match(/chrome/i)&&typeof document.hidden!=="undefined"&&!window.chrome;if('ontouchstart'in window==true&&isSafari7){document.addEventListener("touchmove",function(){history.popstateswipe=true});document.addEventListener("touchend",function(){history.popstateswipe=false})}hasInited=true};Mobilebone.handleTapEvent=function(event){var target=null;if(event&&event.nodeType==1){target=event;target.preventDefault=function(){}}target=target||event.target||event.touches[0],href=target.href;if((!href||/a/i.test(target.tagName)==false)&&(target=target.getParentElementByTag("a"))){href=target.href}var self_page=document.querySelector(".in."+Mobilebone.classPage);if(self_page==null||!target){return}var options={target:target};var attrPrevent=target.getAttribute("data-preventdefault")||_queryToObject(target.getAttribute("data-params")||"").preventdefault;var funPrevent=Mobilebone.getFunction(attrPrevent);if(typeof funPrevent=="function"&&funPrevent(target)==true){event.preventDefault();return false}var ele_mask=target.getElementsByClassName(Mobilebone.classMask)[0];if(ele_mask&&ele_mask.style.display!="none"){event.preventDefault();return false}var idContainer=target.getAttribute("data-container"),classPageInside=target.getAttribute("data-classpage"),container=idContainer&&document.getElementById(idContainer);if(container&&classPageInside&&classPageInside!=Mobilebone.classPage){self_page=container.querySelector(".in."+classPageInside)||container.querySelector(classPageInside);options.history=false;options.title=false;options.classPage=classPageInside}var capture=(Mobilebone.captureLink==true);var rel=target.getAttribute("data-rel");var back=false;if(rel=="back"){back=true}var external=(rel=="external");if(!href){return}href=href.replace("#&","#");if(target.getAttribute("href").replace(/#/g,"")===""){event.preventDefault();return}if(/^javascript/.test(href)){if(back==false){return}}else{external=external||(href.replace("://","").split("/")[0]!==location.href.replace("://","").split("/")[0]);if((external==true||capture==false)&&target.getAttribute("data-ajax")!="true"){return}}if(/^#/.test(target.getAttribute("href"))==true){var idTargetPage=href.split("#")[1],eleTargetPage=idTargetPage&&document.getElementById(idTargetPage);if(back==false&&rel=="auto"){back=Mobilebone.isBack(eleTargetPage,self_page)}if(eleTargetPage){Mobilebone.transition(eleTargetPage,self_page,back,options)}event.preventDefault()}else if(/^javascript/.test(href)){history.tempBack=true;history.back()}else if(target.getAttribute("data-ajax")!="false"){var clean_url=Mobilebone.getCleanUrl(target);var attr_reload=target.getAttribute("data-reload"),id=target.getAttribute("href");if((attr_reload==null||attr_reload=="false")&&store[clean_url]){if(back==false&&rel=="auto"){back=Mobilebone.isBack(store[clean_url],self_page)}options.id=clean_url;var body=container||document.body;if(body.contains(store[clean_url])==false){body.appendChild(store[clean_url])}Mobilebone.transition(store[clean_url],self_page,back,options)}else{Mobilebone.ajax(target)}event.preventDefault()}};Element.prototype.getParentElementByTag=function(tag){if(!tag){return null}var element=null,parent=this;var popup=function(){parent=parent.parentElement;if(!parent){return null}var tagParent=parent.tagName.toLowerCase();if(tagParent===tag){element=parent}else if(tagParent=="body"){element=null}else{popup()}};popup();return element};var _queryToObject=function(string){var obj={};if(typeof string=="string"){string.split("&").forEach(function(part){var arr_part=part.split("=");if(arr_part.length>1){obj[arr_part[0]]=part.replace(arr_part[0]+"=","")}})}return obj};window.addEventListener("DOMContentLoaded",function(){if(hasInited==false){Mobilebone.init()}});window.addEventListener("popstate",function(){if(history.popstateswipe==true){location.reload();history.popstateswipe=false;return}if(history.popstate==false){history.popstate=true;return}var hash=location.hash.replace("#&","").replace(/^#/,""),page_in=null,container=null;if(hash==""){page_in=document.querySelector("."+Mobilebone.classPage);if(page_in.id){return}}else{page_in=store[hash];if(hash.split("container=").length==2){container=document.getElementById(hash.split("container=")[1].split("&")[0])}if(page_in&&isSimple.test(hash)==false){Mobilebone.transition(page_in,((container||document).querySelector(".in."+Mobilebone.classPage)),true,{id:hash,history:false,container:container});return}}if(!page_in){if(isSimple.test(hash)==false){Mobilebone.ajax({url:hash,dataType:"unknown",back:Mobilebone.isBack(),container:container});return}page_in=document.querySelector("#"+hash)}var page_out=document.querySelector(".in."+Mobilebone.classPage);if((page_in&&page_in==page_out)||Mobilebone.pushStateEnabled==false){return}if(page_in){Mobilebone.transition(page_in,page_out,Mobilebone.isBack(page_in,page_out),{id:hash,history:false,remove:false})}});document.MBLOADED=true;return Mobilebone});